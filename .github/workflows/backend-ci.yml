name: .NET CI

on:
  push:
    branches: [ "main", "develop" ]  
  pull_request:
    branches: [ "main", "develop" ]   

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.304

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

      # 5. Run Unit Tests
  - name: ðŸ§ª Run Unit Tests
    run: dotnet test RestaurantManagement.Tests/RestaurantManagement.Tests.csproj --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

  # 6. Upload Test Results
  - name: ðŸ“Š Upload Test Results
    if: always()
    uses: actions/upload-artifact@v4
    with:
      name: test-results
      path: "**/test-results.trx"

  # 7. Generate Coverage Report
  - name: ðŸ“‰ Generate Coverage Report
    run: |
      dotnet test RestaurantManagement.Tests/RestaurantManagement.Tests.csproj \
        --no-build \
        --verbosity normal \
        --collect:"XPlat Code Coverage" \
        --results-directory:"./coverage"

  # 8. Upload Coverage
  - name: ðŸ“¤ Upload Coverage to Codecov
    if: always()
    uses: codecov/codecov-action@v3
    with:
      files: ./coverage/**/coverage.cobertura.xml
      flags: unittests
      name: codecov-report
      fail_ci_if_error: false

  # 9. Summary
  - name: âœ… Build Summary
    run: echo "Build and tests completed successfully!"
